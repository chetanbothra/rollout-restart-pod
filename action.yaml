name: "Kubernetes Rollout Restart"
description: "Detect resource type (Deployment, StatefulSet, DaemonSet), perform rollout restart, and verify rollout status."
author: "DevOps Bot"

inputs:
  namespace:
    description: "Kubernetes namespace"
    required: true
  app_name:
    description: "Kubernetes resource name"
    required: true

outputs:
  result:
    description: "success or failure"

runs:
  using: "composite"
  steps:

    - name: Rollout Restart Logic
      shell: bash
      run: |
        set -euo pipefail

        NS="${{ inputs.namespace }}"
        APP="${{ inputs.app_name }}"

        echo "ðŸ” Detecting resource type..."

        if kubectl get deployment "$APP" -n "$NS" --ignore-not-found --no-headers | grep -q .; then
          RESOURCE_TYPE="deployment"
        elif kubectl get statefulset "$APP" -n "$NS" --ignore-not-found --no-headers | grep -q .; then
          RESOURCE_TYPE="statefulset"
        elif kubectl get daemonset "$APP" -n "$NS" --ignore-not-found --no-headers | grep -q .; then
          RESOURCE_TYPE="daemonset"
        else
          echo "âŒ Resource '$APP' not found in namespace '$NS'"
          echo "result=failure" >> $GITHUB_OUTPUT
          exit 0
        fi

        echo "âž¡ï¸ Resource type detected: $RESOURCE_TYPE"

        echo "ðŸ”„ Performing rollout restart for $APP..."
        kubectl rollout restart $RESOURCE_TYPE/"$APP" -n "$NS"

        echo "â³ Waiting for rollout to complete..."
        if kubectl rollout status $RESOURCE_TYPE/"$APP" -n "$NS" --timeout=300s; then
          echo "Rollout completed successfully!"
          RESULT="success"
        else
          echo "âŒ Rollout failed!"
          RESULT="failure"
        fi

        echo "result=$RESULT" >> $GITHUB_OUTPUT
